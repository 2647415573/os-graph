第十章多处理机操作系统

1710.3多处理机操作系统的特征与分类

10.3.1多处理机操作系统的特征 一 多处理机操作系统是在单机多道程序系统的基础上发展起来的，它们之间有许多相似 之处，但也存在着较大的差异。归纳起来，多处理机操作系统具有以下几方面的新特征：

1.并行性 单机多道程序系统的主要目标是，为用户建立多个虚拟处理机以及模拟多处理机环境， 使程序能并发执行，从而改善资源利用率并提高系统的吞吐量。而在多处理机系统中，由 于存在着多个实处理机，已经可使多个进程并行执行，因此，多处理机操作系统的主要目 标应是进一步增强程序执行的并行性程度，以获得更高的系统吞吐量及提高系统的运算速 度。实际上，在多处理机系统中，每个实处理机仍然可以通过多道程序技术，虚拟为若干 个虚拟处理机，使多个进程在一个实处理机上并发执行。因此，在多处理机系统中，多个 进程之间存在着并行执行和并发执行两种关系。 对于开拓硬件操作的并行性及程序执行的并行性，始终是多处理机系统的中心问题。 前者主要依赖于系统结构的改进，后者则是操作系统的主要目标和任务。为了描述任务的 并行性，控制它们的并行执行，还应该配置相应的并行程序语言，以便在一个任务开始时， 能够派生出与之并行执行的新任务。对于程序执行并行性的开拓，必然导致处理机管理及 存储器管理等功能在实现上的复杂化。

2.分布性 在单处理机系统中，所有的任务都是在同一台处理机上执行的，所有的文件和资源也 都处于操作系统的统一管理之下。然而对于多处理机系统而言，无论其结构如何，在任务、 资源和对它们的控制等方面，都呈现出一定的分布性。这种情况，在松散耦合系统中表现 尤其明显：

（2）资源的分布：各处理机都可能拥有属于自己的本地资源，包括存储器、IO设备等， 对这些资源的使用可以是私有方式，也可以是提供给其它处理机的共享方式；

（3）控制的分布，在系统的每个处理单元上，都可能配置有自己的操作系统，用于控 制本地进程的运行和管理本地资源，以及协调各处理机之间的通信和资源共享。

3.机间的通信和同步性 在多处理机系统中，不仅在同一处理机上并发执行的诸进程之间，由于资源共享和相 互合作的需要，须实现同步和通信，而且在不同处理机上运行的不同进程之间，也需要进 行同步和通信，除了它们之间也需要资源共享和相互合作外，这对于提高程序执行的并行 性、改善系统的性能至关重要。但在多处理机系统中，不同处理机之间的同步和通信，其 实现机制远比单处理机系统要复杂的多，因而成为多处理机操作系统中最重要的问题之一。 315  计算机操作系统

4.可重构性 为提高系统的可靠性，在多处理机系统中，应使操作系统具有这样的能力：当系统中 某个处理机或存储模块等资源发生故障时，系统能够自动切除故障资源，换上备份资源， 并对系统进行重构，保证其能继续工作。如果在故障的处理机上有一个进程正在执行，系 统应能将其安全地转移到其它正常的处理机上继续运行，同时对故障处理机上处于其它状 态的进程，也予以安全的转移。

10.3.2多处理机操作系统的功能 从资源管理观点来看，虽然多处理机操作系统也具有单机操作系统所具有的各种功能， 即进程管理、存储器管理、设备管理、文件管理和作业管理五大功能，但相比之下，在以 下几方面又具有明显的不同：

1.进程管理 对于多处理机系统中的进程管理，主要体现在进程同步和进程通信几个方面： 1）进程同步 在单处理机多道程序系统中，由于各进程只能交替执行，不会发生两个进程在同一时 刻同时访问系统中同一个共享资源的情况。然而，在多处理机环境下，由于多个进程在不 同的处理机上是并行执行的，因而可能出现多个进程对于某个共享资源的同时访问。可见， 在多处理机操作系统中，不仅需要解决程序并发执行时引发的同步问题，而且还需要解决 在多个不同的处理机程序并行执行时所引发的同步问题。因此，对于这两类进程同步问题 的解决机制，除了通常的锁、信号量和管程外，还应具有新的同步机制和互斥算法。 2）进程通信 在单机环境中，所有进程都采用共享同一存储器方式，驻留在同一台机器中。这样， 进程间通信的主要方式是“共享存储器”方式和直接通信方式。但在多处理机环境中，相 互合作的进程可能运行在不同的处理机上，它们之间的通信必然涉及到处理机间的通信， 特别是在松散耦合型的多处理机系统中，进程甚至在不同的机器上，其间的通信还需要较 长的通信信道，甚至要经过网络。因此，在多处理机系统中，进程通信的实现广泛地采用 了间接通信方式。 3）进程调度 在单机环境中，进程调度只是简单地按照一定的算法，从就绪队列中选择一个进程， 为之分配处理机的一个时间片，使之执行一段时间。为平衡IVO负载，在调度时适当地进 行IO任务和计算任务的搭配，以提高系统的资源利用率。但在多处理机系统中，发挥多 处理机最大效能的关键，在于提高程序执行的并行性。因此，在进程调度时，主要应考虑 到如何实现负载的平衡。在调度任务以为其分配处理机时，一方面必须了解每台处理机的 能力，以便把适合的任务分配给它，另一方面，也要确切地了解作业中诸任务之间的关系， 即哪些任务间必须顺序执行，哪些任务可以并行执行。

2.存储器管理 在多处理机环境下，通常每个处理机都有属于自己局部的(本地)存储器，也有可供多 个处理机所共享的(系统)存储器。每个处理机在访问本地存储器模块时，与访问系统存储 316  第十章多处理机操作系统 器或其它处理机的局部存储器模块（统称远地存储器）时相比，所花费的时间也可能是不同 的。因此，在多处理机系统中，存储器系统的结构十分复杂，致使对存储器系统的管理也 还应增强和增加下面的功能和机制：

（1）地址变换机构。该机构不仅用于将虚拟地址转换成实际物理地址，还应能确定所 访问的是本地存储器还是远地存储器。事实上，在目前很多支持多处理机的操作系统中， 对整个存储器系统已经采用连续的地址方式进行描述，即一个处理机无需专门去识别所要 访问的存储器模块的具体位置。

(2）访问冲突仲裁机构。当多个处理机上的进程同时竞争访问某个存储器模块时，该 机构能够按照一定的规则，决定哪一个处理机上的进程可立即访问，哪个或哪些处理机上 的进程应等待。

(3）数据一致性机制。当共享主存中的某个数据在多个处理机的局部(本地)存储器中出 现时，操作系统应保证这些数据的一致性。

3.文件管理 在单处理机系统中，通常只有一个文件系统，所有的文件都存放在磁盘上，采用集中 统一管理方式，也称为集中式文件系统。而在多处理机系统中，则可能采用以下三种文件 系统管理方式：

(1）集中式。所有处理机上的用户文件都集中存放在某一个处理机的文件系统中，由 该处理机的操作系统进行统一管理。

(2）分散式。各处理机上都可配置和管理自己的文件系统，但整个系统没有将它们有 效地组织起来，因而无法实现处理机之间的文件共享。

(3）分布式。系统中的所有文件可以分布在不同的处理机上，但在逻辑上组成一个整 体，每台处理机上的用户无需了解文件的具体物理位置，即可实现对它们的存取。在这样 的文件系统中，解决文件存取的速度和对文件的保护问题，具有很重要的意义。

4.系统重构 在单处理机系统中，一旦处理机发生故障，将引发整个系统的崩溃。但在多处理机系 统中，尤其是在对称多处理机系统中，由于各处理机的结构和功能相同，为了提高系统的 可靠性，应使操作系统具有重构能力，即当系统中某个处理机或存储块等资源发生故障时， 系统能够自动切除故障资源并换上备份资源，使之继续工作。如果没有备份资源，则重构 系统使之降级运行。如果在故障的处理机上有进程函待执行，操作系统应能安全地把它迁 移到其它处理机上继续运行，对处于故障处的其它可利用资源同样也予以安全转移。

10.3.3多处理机操作系统的类型 一一一一 在多处理机系统中，目前所采用的操作系统有以下三种基本类型：

1.主从式（master-slave) 在这种类型的操作系统中，有一台特定的处理机被称为主处理机(MasterProcessor)，其 它处理机则称为从处理机。操作系统始终运行在主处理机上，负责保持和记录系统中所有 处理机的属性、状态等信息，而将其它从处理机视做为可调度和分配的资源，负责为它们 317  计算机操作系统 分配任务。从处理机不具有调度功能，只能运行主处理机分配给它的任务。 其工作流程是：由从处理机向主处理机提交任务申请，该请求被捕获后送至主处理机， 而后等待主处理机发回应答；主处理机收到请求后中断当前任务，对该请求进行识别和判 断，并转入执行相应的处理程序，然后将适合的任务分配给发出请求的从处理机。例如， CDCCyber-170就是典型的主从式多处理机操作系统，它驻留在一个外围处理机Po上运行， 其余所有处理机包括中心处理机都从属于Po，Po专门用于执行操作系统功能，处理用户程 序(运行在从处理机上)发来的请求。另外一个例子就是DECSystem10，该系统有两台处理 机，一台为主处理机，另一台为从处理机。 主从式操作系统具有如下优缺点：

（1）易于实现。一方面其设计可在传统的单机多道程序系统上进行适当的扩充；另一方面， 由于操作系统程序仅被一台主处理机使用，因此除了一些公用例程外，不需要将整个管理程序

(2）资源利用率低。由于从处理机的所有任务都是由主处理机分配的，当从处理机数 量较多时，或者从处理机执行的是大量的短任务时，在主处理机上会出现较长的请求任务 队列，形成了瓶颈，使从处理机长时间处于等待状态，导致从处理机以及其所配置的IV/O 设备利用率降低。因此，一方面，系统中从处理机的数量不宜设置过多，另一方面主处理 机在分配任务时，不宜将任务划分得过小，以避免从处理机频繁地发出请求。

（3）安全性较差。由于系统中只有一台主处理机，并且由其负责运行操作系统，对整 尽管主一从式操作系统的资源利用率低下、安全性较差，但因其易于实现，所以在早 期的多处理机系统中还主要采用这样的形式，直至目前，仍有不少的多处理机系统采用它。 一般用于工作负载不是太重、从处理机数量不是太多、从处理机性能远低于主处理机的非 对称多处理机系统中。

2.独立监督式（separatesupervisorSystem） 独立监督式，也称为独立管理程序系统，它与主从式不同。在这种系统中，每个处理 机上都有自己的管理程序(操作系统内核)，并拥有各自的专用资源，如IO设备和文件系统。 每一个处理机上所配置的操作系统也具有与单机操作系统类似的功能，以服务自身的需要， 及管理自己的资源和为进程分配任务。采用独立监督式操作系统的多处理机系统有IBM 370/158等。独立监督式操作系统具有如下的优缺点：

（1）自主性强。每个处理机都拥有独立的、完善的硬、软件资源，可根据自身以及分 配给它的任务的需要，执行各种管理功能，从而使系统具有较强的独立性和自主性。

(2）可靠性高。每个处理机相对独立，因此一台处理机的故障不会引起整个系统崩溃， 使系统具有较高的可靠性。但是，由于缺乏一个统一的管理和调度机制，一旦出现故障， 要想进行补救或重新执行故障机未完成的工作，就显得非常困难。

（3）实现复杂。由于存在着通信和资源共享的需要，各处理机之间必然有交互作用， 即多个处理机都可能在执行管理程序，因此管理程序的代码必须是可重入的，或者为每个 处理机提供一个专用的管理程序副本。此外，虽然每个处理机都有其专用的管理程序，对 公用表格的访问冲突较少，阻塞情况也相应减少，系统的效率较主从式有所提高，但仍然 318  会因为都要对一些公用表格进行访问而发生冲突，因此系统中还是需要设置冲突仲裁机构。

（4）存储空间开销大。一般地，这类操作系统适用于松散耦合型多处理机系统，由于 每个处理机均有一个本地（局部)存储器，用来存放管理程序副本，即每台处理机中都驻留了 操作系统内核，占用了大量的存储空间，造成较多的存储余，致使存储空间利用率不高。

（5）处理机负载不平衡。由于不能像主一从式系统中那样，由一个主处理机统一负责 整个系统的管理和调度，因而要实现处理机负载平衡非常困难。

3.浮动监督式（floatingsupervisorControlMode) 浮动监督式，也称为浮动管理程序控制方式，这是最复杂的，但也是最有效、最灵活 的一种多处理机操作系统方式，常用于紧密耦合式的对称多处理机系统中。在这种方式实 现的系统中，所有的处理机组成一个处理机池，每台处理机都可对整个系统中的任何一台 IVO设备进行控制，以及对任何一个存储器模块进行访问，这些处理机由操作系统统一进行 管理，在某段时间内可以指定任何一台（或多台）处理机作为系统的控制处理机，即所谓“主” 处理机（或组），由它（或它们)运行操作系统程序，负责全面管理功能，但根据需要，“主” 处理机是可以浮动的，即从一台处理机切换到另一台处理机。采用这种操作系统方式的多 处理机系统有IBM3081上运行的MVS，VM以及C·mmp上运行的Hydra等。 浮动监督式操作系统具有如下的优缺点：

（1）高灵活性。由于对于系统内所有的处理机采用的是处理机池管理方式，其中每一 台处理机都可用于控制任一台I/O设备和访问任一存储块，因此大多数任务可在任何一台 处理机上运行，使系统的灵活性相当强。

(2）高可靠性。在上述三种操作系统中，浮动监督式操作系统具有最好的可靠性。因 为，系统中任何一台(从)处理机的失效，不过是处理机池中减少了一台可供分配的处理机 而已；而如果是“主”处理机失效，也只需将操作系统浮动（切换）到另一台处理机上运行， 从而保证系统仍能继续正常运行下去。

(3）负责均衡。在这样的系统中，一方面由于大多数任务可以在任何一台处理机上运 行，另一方面也因为在系统中设置了一台（或多台）“主”处理机，对整个系统的资源和调 度进行了统一的管理，因此可以根据各处理机的忙闲情况，将任务均匀分配到各处理机上 执行，尤其是可以将一些非专门的操作（如IO中断)，分配给那些在特定时段内最不忙的处 理机去执行，使系统的负载达到较好的平衡。

(4）实现复杂。一方面，由于对存储器模块和系统表格访问冲突的不可避免，需要配 置功能较强的冲突仲裁机构，包括硬件和软件两方面。例如，多个处理机同时访问同一存 储器模块时，可采用硬件解决；而对系统表格的冲突访问，则可采用静态或动态优先级策略； “主”处理机，即可以同时执行同一个管理服务子程序，因此，要求管理程序具有可重入性。

10.4进程同步 在多处理机系统中，进程间的同步显得更加重要和复杂。在紧密耦合多处理机中，多 个处理机是共享存储的，因此各处理机上的诸进程之间可通过该共享存储来实现同步，进 319