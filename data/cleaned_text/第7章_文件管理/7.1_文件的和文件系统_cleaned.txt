第七章文件管理 第七章文件管理 9999999999999999 由于计算机中的内存是易失性设备，断电后所存储之信息即会丢失，其容量又十分有 限，所以在现代计算机系统中，都必须配置外存，将系统和用户需要用到的大量程序和数 据以文件的形式存放在外存中，需要时再随时将它们调入内存，或将它们打印出来。如果 由用户直接管理存放在外存上的文件，不仅要求用户熟悉外存特性，了解各种文件的属性， 以及它们在外存上的位置，而且在多用户环境下还必须能保持数据的安全性和一致性。显 然，这是用户所不能胜任的。于是在操作系统中又增加了文件管理功能，专门管理在外存 上的文件，并把对文件的存取、共享和保护等手段提供给用户。这不仅方便了用户，保证 了文件的安全性，还可有效地提高系统资源的利用率。

7.1，文件和文件系统 文件系统的管理功能是将其管理的程序和数据通过组织为一系列文件的方式实现的。而 文件则是指具有文件名的若干相关元素的集合。元素通常是记录，而记录又是一组有意义的 数据项的集合。可见，基于文件系统的概念，可以把数据组成分为数据项、记录和文件三级。

7.1.1数据项、记录和文件

1.数据项 在文件系统中，数据项是最低级的数据组织形式，可把它分成以下两种类型：

（1）基本数据项。这是用于描述一个对象的某种属性的字符集，是数据组织中可以命 名的最小逻辑数据单位，又称为字段。例如，用于描述一个学生的基本数据项有：学号、 姓名、年龄、所在班级等。

(2）组合数据项。是由若干个基本数据项组成的，简称组项。例如工资是个组项，它 可由基本工资、工龄工资和奖励工资等基本项所组成。 基本数据项除了数据名外，还应有数据类型。因为基本项仅描述某个对象的属性，根 据属性的不同，需要用不同的数据类型来描述。例如，在描述学生的学号时应使用整数； 描述学生的姓名则应使用字符串（含汉字)：描述性别时可用逻辑变量或汉字。可见，由数 则称为“值”。例如，学号/30211、姓名/王有年、性别/男等。

2.记录 记录是一组相关数据项的集合，用于描述一个对象在某方面的属性。一个记录应包含 221  计算机操作系统 哪些数据项，取决于需要描述对象的哪个方面。由于对象所处的环境不同可把他作为不同 的对象。例如，一个学生，当把他作为班上的一名学生时，对他的描述应使用学号、姓名、 年龄及所在系班，也可能还包括他所学过的课程的名称、成绩等数据项。但若把学生作为 一个医疗对象时，对他描述的数据项则应使用诸如病历号、姓名、性别、出生年月、身高、 体重、血压及病史等项。 一个或几个数据项，把它们的集合称为关键字(key)。或者说，关键字是唯一能标识一个记 录的数据项。通常，只需用一个数据项作为关键字。例如，前面的病历号或学号便可用来 从诸多记录中标识出唯一的一个记录。然而有时找不到这样的数据项，只好把几个数据项 定为能在诸多记录中唯一地标识出某个记录的关键字。

3.文件 文件是指由创建者所定义的、具有文件名的一组相关元素的集合，可分为有结构文件 和无结构文件两种。在有结构的文件中，文件由若干个相关记录组成，而无结构文件则被 看成是一个字符流。文件在文件系统中是一个最大的数据单位，它描述了一个对象集。例 如，可以将一个班的学生记录作为一个文件。 文件属性可以包括：

（1）文件类型。可以从不同的角度来规定文件的类型，如源文件、目标文件及可执行 文件等。

(2）文件长度。文件长度指文件的当前长度，长度的单位可以是字节、字或块，也可 能是最大允许的长度。

(3）文件的物理位置。该项属性通常用于指示文件所在的设备及所在设备中地址的指针。

（4）文件的建立时间。这是指最后一次的修改时间等。 图7-1示出了文件、记录和数据项之间的层次关系。 文件 记录1 记录2 .·. 记录n 数据项1 数据项2 数据项n *.. 图7-1文件、记录和数据项之间的层次关系

7.1.2文件名和类型 一←

1.文件名和扩展名

(1）文件名。在不同的系统之间，对文件名的规定是不同的，在一些老的系统中，名 字的长度受到限制。例如，MS-DOS最多只允许8个字符，老版的UNIX系统支持14个 字符。另外，一些特殊字符也规定不能用于文件名，如空格，因其常被用作分隔命令、参 数和其它数据项的分隔符。近年推出的不少OS已放宽了这种限制，如WindowsNT及以 222  第七章文件管理 后的Windows2000/XP/Vista/7/8等所采用的NTFS文件系统，便可以很好地支持长文件名。 另外，在早期的OS中，如MS-DOS和Windows95等，是不区分大小写字母的，如MYFILE、 MYfile和myfile都是指同一个文件。但在UNIX和Linux系统中是区分大小写的，因此， 上面的三个文件名字用于标识不同的文件。

（2）扩展名。扩展名是添加在文件名后面的若干个附加字符，又称为后缀名，用于指 示文件的类型。它可以方便系统和用户了解文件的类型，它是文件名中的重要组成部分。 在大多数系统中，用圆点“”将文件名和扩展名分开。例如，myfile.txt中的扩展名txt， 表示该文件是文本文件：myprog.bin中的扩展名bin，表示该文件是一个可执行的二进制文 件。扩展名的长度一般是1～4个字符。

2.文件类型 为了便于管理和控制文件，将文件分成若干种类型。由于不同的系统对文件管理方式 的不同，因此它们对文件的分类方法也有很大差异。下面是常用的几种文件分类方法。 1）按用途分类 根据文件的性质和用途的不同，可将文件分为三类：

（1）系统文件，这是指由系统软件构成的文件。大多数的系统文件只允许用户调用， 但不充许用户去读，更不允许修改；有的系统文件不直接对用户开放。

(2）用户文件，指由用户的源代码、目标文件、可执行文件或数据等所构成的文件。 用户将这些文件委托给系统保管。

（3）库文件，这是由标准子例程及常用的例程等所构成的文件。这类文件允许用户调 用，但不充许修改。 2）按文件中数据的形式分类 按这种方式分类，也可把文件分为三类：

(1）源文件，这是指由源程序和数据构成的文件。通常，由终端或输入设备输入的源 程序和数据所形成的文件都属于源文件。它通常是由ASCI码或汉字所组成的。

（2）目标文件，这是指把源程序经过编译程序编译过，但尚未经过链接程序链接的目 标代码所构成的文件。目标文件所使用的后缀名是“.obj”。

（3）可执行文件，这是指把编译后所产生的目标代码经过链接程序链接后所形成的文 件。其后缀名是.exe。 3）按存取控制属性分类 根据系统管理员或用户所规定的存取控制属性，可将文件分为三类：

（1）只执行文件，该类文件只允许被核准的用户调用执行，不允许读和写。

(2）只读文件，该类文件只充许文件主及被核准的用户去读，不允许写。

(3）读写文件，这是指允许文件主和被核准的用户去读或写的文件。 4）按组织形式和处理方式分类 根据文件的组织形式和系统对其处理方式的不同，可将文件分为三类：

（1）普通文件，是由ASCII码或二进制码组成的字符文件，一般用户建立的源程序文 件、数据文件以及操作系统自身代码文件、实用程序等都是普通文件。

(2）目录文件，是由文件目录组成的文件，通过目录文件可以对其下属文件的信息进 223  计算机操作系统 行检索，对其可执行的文件进行操作，与普通文件一样。

(3）特殊文件，特指系统中的各类I/O设备。为了便于统一管理，系统将所有的IVO设 备都视为文件，并按文件方式提供给用户使用，如目录的检索、权限的验证等都与普通文 件相似，只是对这些文件的操作将由设备驱动程序来完成。

7.1.3文件系统的层次结构 → 如图7-2所示，文件系统的模型可分为三个层次：最底层是对象及其属性，中间层是 对对象进行操纵和管理的软件集合，最高层是文件系统提 用户（程序） 供给用户的接口。

1.对象及其属性 文件管理系统管理的对象如下： 文件系统接口

（1）文件。在文件系统中有着各种不同类型的文件， 对对象操纵和管理的软件集合 它们都作为文件管理的直接对象。 对象及其属性

(2）目录。为了方便用户对文件的存取和检索，在文 件系统中必须配置目录，在目录的每个目录项中，必须含 图7-2文件系统模型 有文件名、对文件属性的说明，以及该文件所在的物理地 址（或指针）。对目录的组织和管理，是方便用户和提高对文件存取速度的关键。

（3）磁盘（磁带）存储空间。文件和目录必定占用存储空间，对这部分空间的有效管理， 不仅能提高外存的利用率，而且能提高对文件的存取速度。

2.对对象操纵和管理的软件集合 该层是文件管理系统的核心部分。文件系统的功能大多是在这一层实现的，其中包括有： ①对文件存储空间的管理；②对文件目录的管理；③用于将文件的逻辑地址转换为物理 地址的机制；④对文件读和写的管理；对文件的共享与保护等功能。在实现这些功能 时，OS通常都采取了层次组织结构，即在每一层中都包含了一定的功能，处于某个层次的 软件，只能调用同层或更低层次中的功能模块。 一般地，把与文件系统有关的软件分为四个层次：

（1）I/O控制层，是文件系统的最低层，主要由磁盘驱动程序等组成，也可称为设备驱 动程序层。

（2）基本文件系统层，主要用于处理内存与磁盘之间数据块的交换。

（3）基本I/O管理程序，该层用于完成与磁盘I/O有关的事务，如将文件逻辑块号转换 为物理块号，管理磁盘中的空闲盘块，IV/O缓冲的指定等。

（4）逻辑文件系统，用于处理与记录和文件相关的操作，如允许用户和应用程序使用 符号文件名访问文件及记录，实现对文件和记录的保护等。

3.文件系统的接口 为方便用户的使用，文件系统以接口的形式提供了一组对文件和记录操作的方法和手 段。通常是下面两种类型的接口：

(1）命令接口，是指作为用户与文件系统直接交互的接口，用户可通过键盘终端键入 命令取得文件系统的服务。 224  第七章文件管理

(2）程序接口，是指作为用户程序与文件系统的接口，用户程序可通过系统调用取得 文件系统的服务，例如，用于创建文件的系统调用Creat，用于打开一个文件的系统调用 Open等。

7.1.4文件操作 一→ 用户可以通过文件系统提供的系统调用实施对文件的操作。最基本的文件操作包括创 建、删除、读、写和设置文件的读/写位置等。实际上，一般的OS都提供了更多对文件的 操作，如打开和关闭一个文件及改变文件名等操作。

1.最基本的文件操作 最基本的文件操作包含下述内容：

（1）创建文件。在创建一个新文件时，要为新文件分配必要的外存空间，并在文件目 录中为之建立一个目录项：目录项中应记录新文件的文件名及其在外存的地址等属性。

(2）删除文件。在删除时，应先从目录中找到要删除文件的目录项，使之成为空项， 然后回收该文件所占用的存储空间。 外存中的位置；在目录项中，还有一个指针用于对文件的读/写。

（4）写文件。在写文件时，根据文件名查找目录，找到指定文件的目录项，再利用目 录中的写指针进行写操作。

(5）设置文件的读/写位置。前面所述的文件读/写操作，都只提供了对文件顺序存取的 手段，即每次都是从文件的始端进行读或写：设置文件读/写位置的操作，通过设置文件 因此可以改顺序存取为随机存取。

2.文件的“打开”和“关闭”操作 当用户要求对一个文件实施多次读/写或其它操作时，每次都要从检索目录开始。为了 避免多次重复地检索目录，在大多数OS中都引[入了“打开”（open)这一文件系统调用，当 用户第一次请求对某文件进行操作时，须先利用open系统调用将该文件打开。所谓“打开” 是指系统将指名文件的属性（包括该文件在外存上的物理位置），从外存拷贝到内存打开文 件表的一个表目中，并将该表目的编号（或称为索引号）返回给用户。换而言之，“打开”， 就是在用户和指定文件之间建立起一个连接。此后，用户可通过该连接直接得到文件信息， 从而避免了再次通过目录检索文件，即当用户再次向系统发出文件操作请求时，系统根据 用户提供的索引号可以直接在打开文件表中查找到文件信息。这样不仅节省了大量的检索 开销，也显著地提高了对文件的操作速度。如果用户已不再需要对该文件实施相应的操作， 可利用“关闭”（close)系统调用来关闭此文件，即断开此连接，Os将会把该文件从打开文 件表中的表目上删除掉。

3.其它文件操作 OS为用户都提供了一系列文件操作的系统调用，其中最常用的一类是有关对文件属性 的操作，即允许用户直接设置和获得文件的属性，如改变已存文件的文件名、改变文件的 拥有者(文件主)、改变对文件的访问权，以及查询文件的状态（包括文件类型、大小和拥有 225  计算机操作系统 者以及对文件的访问权等）。另一类是有关目录的操作，如创建一个目录，删除一个目录， 改变当前目录和工作目录等。此外，还有用于实现文件共享的系统调用，以及用于对文件 系统进行操作的系统调用等。 /7.2 2文件的逻辑结构 用户所看到的文件称为逻辑文件，它是由一系列的逻辑记录组成的。从用户的观点而 言，文件的逻辑记录是能够被存取的基本单位。在进行文件系统高层设计时，所涉及的主 要问题是文件的逻辑结构，即如何将这些逻辑记录构成一个逻辑文件。在进行文件系统低 层设计时，所涉及的主要问题是文件的物理结构，即如何将一个文件存储在外存上。由此 可见，在系统中的所有文件都存在着以下两种形式的文件结构：

(1）文件的逻辑结构（FileLogicalStructure)。这是从用户观点出发所观察到的文件组织 形式，即文件是由一系列的逻辑记录组成的，是用户可以直接处理的数据及其结构，它独 立于文件的物理特性，又称为文件组织(FileOrganization)。

(2）文件的物理结构，又称为文件的存储结构。这是指系统将文件存储在外存上所形 成的一种存储组织形式，是用户不能看见的。文件的物理结构不仅与存储介质的存储性能 有关，而且与所采用的外存分配方式有关。无论是文件的逻辑结构，还是其物理结构，都 会影响对文件的检索速度。

7.2.1文件逻辑结构的类型 对文件逻辑结构所提出的基本要求，首先是有助于提高对文件的检索速度，即在将大 批记录组成文件时，应采用一种有利于提高检索记录速度和效率的逻辑结构形式。其次是 该结构应方便对文件进行修改，即便于在文件中增加、删除和修改一个或多个记录。第三 是降低文件存放在外存上的存储费用，即尽量减少文件占用的存储空间，不要求大片的连 续存储空间。 文件的逻辑结构从是否有结构来分，可分为两大类：一类是有结构文件，这是指由一 个以上的记录构成的文件，故又把它称为记录式文件；另一类是无结构文件，这是指由字 符流构成的文件，敌又称为流式文件。从文件的组织方式来分，可以分为顺序文件、索引 文件和索引顺序文件几种。

1.按文件是否有结构分类 1）有结构文件 在记录式文件中，每个记录都用于描述实体集中的一个实体，各记录有着相同或不同 数目的数据项。记录的长度可分为定长和不定长两类。

(1）定长记录，是指文件中所有记录的长度都是相同的，所有记录中的各数据项都处 在记录中相同的位置，具有相同的顺序和长度，文件的长度用记录数目表示。定长记录能 有效地提高检索记录的速度和效率，能方便对文件进行处理和修改，所以这是目前较常用 的一种记录格式，被广泛用于数据处理中。

(2）变长记录，是指文件中各记录的长度不相同。产生变长记录的原因可能是由于一 226