

--- Page 189 ---
计算机操作系统
第六章输几输出系统
I/O系统是OS的重要组成部分，用于管理诸如打印机和扫描仪等I/O设备，以及用于
存储数据，如磁盘驱动器和磁带机等各种存储设备。由于IO系统所含设备类型繁多，差
异又非常大，致使I/O系统成为操作系统中最繁杂且与硬件最紧密相关的部分。
76.1I/0 系统的功能、模型和接口
IVO系统管理的主要对象是IVO设备和相应的设备控制器。其最主要的任务是，完成用
户提出的IVO请求，提高IO速率，以及提高设备的利用率，并能为更高层的进程方便地
使用这些设备提供手段。
6.1.110系统的基本功能
为了满足系统和用户的要求，IVO系统应具有下述几方面的基本功能，其中，第一、二
方面的功能是为了方便用户使用I/O设备；第三、四方面的功能是用于提高CPU和I/O设
备的利用率；第五、六方面的功能是为用户在共享设备时提供方便，以保证系统能有条不
紊的运行，当系统发生错误时能及时发现错误，甚至于能自动修正错误。
1.隐藏物理设备的细节
I/O设备的类型非常多，且彼此间在多方面都有差异，诸如它们接收和产生数据的速度，
传输方向、粒度、数据的表示形式及可靠性等方面。为了对这些千差万别的设备进行控制，
通常都为它们配置相应的设备控制器。这是一种硬件设备，其中包含有若干个用于存放控
制命令的寄存器和存放参数的寄存器。用户通过这些命令和参数，可以控制外部设备执行
所要求的操作。
显然，对于不同的设备，需要有不同的命令和参数。例如，在对磁盘进行操作时，不
仅要给出本次是读还是写的命令，还需给出源或目标数据的位置，包括磁盘的盘面号、磁
道号和扇区号。由此可见，如果要求程序员或用户编写直接面向这些设备的程序，是极端
困难的。因此，IIO系统必须通过对设备加以适当的抽象，以隐藏掉物理设备的实现细节，
仅向上层进程提供少量的、抽象的读/写命令，如read、write等。实际上，关于隐藏性问题，
我们在第一章中已做了类似的介绍。
2.与设备的无关性
隐藏物理设备的细节，在早期的OS中就已实现，它可方便用户对设备的使用。与设
178

--- Page 190 ---
第六章输入输出系统
备的无关性是在较晚时才实现的，这是在隐藏物理设备细节的基础上实现的。一方面，用
户不仅可以使用抽象的IO命令，还可使用抽象的逻辑设备名来使用设备，例如，当用户
要输出打印时，他只须提供读(或写)的命令(提出对I/O的要求)，和提供抽象的逻辑设备名，
性和易适应性，对于OS本身而言，应允许在不需要将整个操作系统进行重新编译的情况
下，增添新的设备驱动程序，以方便新的I/O设备的安装。如Windows中，系统可以为新
I/O设备自动安装和寻找驱动程序，从而做到即插即用。
3.提高处理机和V/O设备的利用率
在一般的系统中，许多I/O设备间是相互独立的，能够并行操作，在处理机与设备之
间也能并行操作。因此，I/O系统的第三个功能是要尽可能地让处理机和I/O设备并行操作，
以提高它们的利用率。为此，一方面要求处理机能快速响应用户的I/O请求，使I/O设备
尽快地运行起来；另一方面也应尽量减少在每个I/O设备运行时处理机的干预时间。在本
章中将介绍许多有助于实现该目标的方法。
4.对VO设备进行控制
对IO设备进行控制是驱动程序的功能。目前对I/O设备有四种控制方式：①采用轮
询的可编程IO方式：②采用中断的可编程IO方式；③直接存储器访问方式：④I/O
通道方式。具体应采用何种控制方式，与IO设备的传输速率、传输的数据单位等因素有
关。如打印机、键盘终端等低速设备，由于其传输数据的基本单位是字节（或字），故应采
用中断的可编程IVO方式；而对于磁盘、光盘等高速设备，由于其传输数据的基本单位是
数据块，故应采用直接存储器访问方式，以提高系统的利用率；而IO通道方式的引入，
使对I/O操作的组织和数据的传输，都能独立进行而无需CPU的干预。为了方便高层软件
和用户，显然IVO软件也应屏蔽掉这种差异，向高层软件提供统一的操作接口。
5.确保对设备的正确共享
从设备的共享属性上，可将系统中的设备分为如下两类：
（1）独占设备，进程应互斥地访问这类设备，即系统一旦把这类设备分配给了某进程
后，便由该进程独占，直至用完释放。典型的独占设备有打印机、磁带机等。系统在对独
占设备进行分配时，还应考虑到分配的安全性。
（2）共享设备，是指在一段时间内允许多个进程同时访问的设备。典型的共享设备是
磁盘，当有多个进程需对磁盘执行读、写操作时，可以交叉进行，不会影响到读、写的正
确性。
6.错误处理
大多数的设备都包括了较多的机械和电气部分，运行时容易出现错误和故障。从处理
的角度，可将错误分为临时性错误和持久性错误。对于临时性错误，可通过重试操作来纠
正，只有在发生了持久性错误时，才需要向上层报告。例如，在磁盘传输过程中发生错误，
系统并不认为磁盘已发生了故障，而是可以重新再传，一直要重传多次后，若仍有错，才
认为磁盘发生了故障。由于多数错误是与设备紧密相关的，因此对于错误的处理，应该尽
可能在接近硬件的层面上进行，即在低层软件能够解决的错误就不向上层报告，因此高层
179

--- Page 191 ---
计算机操作系统
也就不能感知；只有低层软件解决不了的错误才向上层报告，请求高层软件解决。
6.1.21/0系统的层次结构和模型
I/O软件涉及的面很宽，向下与硬件有密切关系，向上又与文件系统、虚拟存储器系统
和用户直接交互，它们都需要IVO系统来实现IVO操作。为使十分复杂的IVO软件能具有清
晰的结构、更好的可移植性和易适应性，目前已普遍采用层次式结构的IV/O系统。这是将
系统中的设备管理模块分为若干个层次，每一层都是利用其下层提供的服务，完成输入输
出功能中的某些子功能，并屏蔽这些功能实现的细节，向高层提供服务。
1.VO软件的层次结构
通常把IO软件组织成四个层次，如图6-1所示，各层次及其功能如下，图中的箭头
表示I/O的控制流：
（1）用户层IVO软件，实现与用户交互的接口，用户可直接调用该层所提供的、与IVO
操作有关的库函数对设备进行操作。
(2）设备独立性软件，用于实现用户程序与设备驱动器的统一接口、设备命名、设备
的保护以及设备的分配与释放等，同时为设备管理和数据传送提供必要的存储空间。
（3）设备驱动程序，与硬件直接相关，用于具体实现系统对设备发出的操作指令，驱
动I/O设备工作的驱动程序。
（4）中断处理程序，用于保存被中断进程的CPU环境，转入相应的中断处理程序进行
处理，处理完毕再恢复被中断进程的现场后，返回到被中断的进程。
VO应答
用户层软件
产生I/O请求、格式化I/O、Spooling
设备独立性软件
映射、保护、分块、缓冲、分配
设备驱动程序
设置设备寄存器：检查状态
中断处理程序
硬件
执行I/O操作
图6-1I/O系统的层次结构
2.1/0系统中各种模块之间的层次视图
为了能更清晰地描述I/O系统中主要模块之间的关系，我们进一步介绍IV/O系统中各
种I/O模块之间的层次视图。见图6-2所示。
1)I/O系统的上、下接口
（1）I/O系统接口。它是IO系统与上层系统之间的接口，向上层提供对设备进行操作
的抽象I/O命令，以方便高层对设备的使用。有不少OS在用户层提供了与I/O操作有关的
库函数，供用户使用。在上层系统中有文件系统、虚拟存储器系统以及用户进程等。
(2）软件/硬件(RW/HW)接口。下面一个接口是软件/硬件接口，在它的上面是中断处理
程序和用于不同设备的设备驱动程序。在它的下面是各种设备的控制器。如CD-ROM控制
器、硬盘控制器、键盘控制器、打印机控制器、网络控制器等，它们都属于硬件。由于设
备种类繁多，故该接口相当复杂。如图6-2所示，在上、下两个接口之间则是IO系统。
180

--- Page 192 ---
第六章
输入输出系统
应用程序
用户层软件
虚拟内存
文件系统
管理
IVO系统接口
网络接口
打开/关闭
块设备接口
打开/关闭
打开/关闭
流设备接口
取/放
读/写
发送/接收
io_control
设备独立性
软件
块设备管理
流设备管理
网络通信软件
CD-ROM
硬盘
键盘
打印机
网络
设备驱动程序
驱动程序
驱动程序
驱动程序
驱动程序
驱动程序
1
CD-ROM
硬盘
键盘
打印机
网络
中断处理程序
中断处理程序
中断处理程序
中断处理程序
中断处理程序
中断处理程序
RW/HW接口
Y
键盘
CD-ROM
硬盘
打印机
网络
设备控制器
控制器
控制器
控制器
控制器
控制器
Y
光盘
硬盘
键盘
打印机)
网络
驱动器
驱动器
图6-2I/O系统中各种模块之间的层次视图
2）I/O系统的分层
与前面所述的IVO软件组织的层次结构相对应，IVO系统本身也可分为如下三个层次：
（1）中断处理程序。它处于IO系统的底层，直接与硬件进行交互。当有IVO设备发来
中断请求信号时，在中断硬件做了初步处理后，便转向中断处理程序。它首先保存被中断
进程的CPU环境，然后转入相应设备的中断处理程序进行处理，在处理完成后，又恢复被
中断进程的CPU环境，返回断点继续运行。
（2）设备驱动程序。它处于IVO系统的次底层，是进程和设备控制器之间的通信程序，
其主要功能是，将上层发来的抽象I/O请求转换为对I/O设备的具体命令和参数，并把它
装入到设备控制器中的命令和参数寄存器中，或者相反。由于设备之间的差异很大，每类
设备的驱动程序都不相同，故必须由设备制造厂商提供，而不是由OS设计者来设计。因
此，每当在系统中增加一个新设备时，都需要由安装厂商提供新的驱动程序。
（3）设备独立性软件。现代OS中的IO系统基本上都实现了与设备无关性，也称为与设
备无关的软件。其基本含义是：I/O软件独立于具体使用的物理设备。由此带来的最大好处
是，提高了IO系统的可适应性和可扩展性。使它们能应用于许多类型的设备，而且在每次
增加新设备或替换老设备时，都不需要对IVO软件进行修改，这样就方便了系统的更新和扩
展。设备独立性软件的内容包括设备命名、设备分配、数据缓冲和数据高速缓冲一类软件等。
6.1.31/0系统接口
在IVO系统与高层之间的接口中，根据设备类型的不同，又进一步分为若干个接口。
在图6-2中示出了块设备接口、流设备接口和网络接口。
1.块设备接口
块设备接口是块设备管理程序与高层之间的接口。该接口反映了大部分磁盘存储器和
181

--- Page 193 ---
计算机操作系统
光盘存储器的本质特征，用于控制该类设备的输入或输出。
（1）块设备。所谓块设备，是指数据的存取和传输都是以数据块为单位的设备。典型
的块设备是磁盘。该设备的基本特征是传输速率较高，通常每秒钟为数MB 到数十MB。
另一特征是可寻址，即能指定数据的输入源地址及输出的目标地址，可随机地读/写磁盘中
任一块；磁盘设备的I/O常采用DMA方式。
(2）隐藏了磁盘的二维结构。块设备接口将磁盘上的所有扇区从0到n-1依次编号，n
是磁盘中的扇区总数。经过这样编号后，就把磁盘的二维结构改变为一种线性序列。在二
维结构中，每个扇区的地址需要用磁道号和扇区号来表示。或者说，块设备接口隐藏了磁
盘地址是二维结构的情况。
（3）将抽象命令映射为低层操作。块设备接口支持上层发来的对文件或设备的打开、
读、写和关闭等抽象命令。该接口将上述命令映射为设备能识别的较低层具体操作。例如，
上层发来读磁盘命令时，它先将抽象命令中的逻辑块号转换为磁盘的盘面、磁道和扇区等。
虚拟存储器系统也需要使用块设备接口，因为在进程运行期间，每当它所访问的页面
不在内存时便会发生缺页中断，此时就需要利用IO系统，通过块设备接口从磁盘存储器
中将所缺之页面调入内存。
2.流设备接口
流设备接口是流设备管理程序与高层之间的接口。该接口又称为字符设备接口，它反
映了大部分字符设备的本质特征，用于控制字符设备的输入或输出。
（1）字符设备。所谓字符设备，是指数据的存取和传输是以字符为单位的设备，如键
盘、打印机等。字符设备的基本特征是传输速率较低，通常为每秒几个字节至数千字节。
另一特征是不可寻址，即不能指定数据的输入源地址及输出的目标地址。字符设备在输入/
输出时，常采用中断驱动方式。
(2）get和put操作。由于字符设备是不可寻址的，因而对它只能采取顺序存取方式。
入)，或从字符缓冲区顺序地送出到设备（输出）。用户程序获取或输出字符的方法是采用get
和put操作。get操作用于从字符缓冲区取得一个字符(到内存)，将它返回给调用者。而put
操作则用于把一个新字符(从内存)输出到字符缓冲区中，以待送出到设备。
（3）in-control指令。因字符设备的类型非常多，且差异甚大，为了以统一的方式来处
理它们，通常在流设备接口中提供了一种通用的in-control指令，在该指令中包含了许多参
数，每个参数表示一个与具体设备相关的特定功能。
由于大多数流设备都属于独占设备，必须采取互斥方式实现共享，为此，流设备接口
提供了打开和关闭操作。在使用这类设备时，必须先用打开操作来打开设备。如果设备已
被打开，则表示它正被其它进程使用。
3.网络通信接口
在现代OS中，都提供了面向网络的功能。但首先还需要通过某种方式把计算机连接到网
络上。同时操作系统也必须提供相应的网络软件和网络通信接口，使计算机能通过网络与网络
上的其它计算机进行通信或上网浏览。由于网络通信接口涉及到许多关于网络方面的知识，如
网络中的网络通信协议和网络的层次结构等，故放在第10.6节（网络操作系统)中做专门的介绍。
182

--- Page 194 ---
/6.21/0设备和设备控制器
IO设备一般是由执行IO操作的机械部分和执行控制I/O的电子部件组成。通常将这
两部分分开，执行IO操作的机械部分就是一般的I/O设备，而执行控制IO的电子部件则
称为设备控制器或适配器（adapter)。在微型机和小型机中的控制器常做成印刷电路卡形式，
因而也常称为控制卡、接口卡或网卡，可将它插入计算机的扩展槽中。在有的大、中型计
算机系统中，还配置了I/O通道或IO处理机。
6.2.11/0设备
一
1.I/O设备的类型
I/O设备的类型繁多，除了能将它们分为块设备和字符设备、独占设备和共享设备外，
还可从设备使用特性上分为存储设备和IO设备；从设备的传输速率上又分为高速设备、
中速共享设备和高速共享设备。下面对这两种分类进行介绍。
1）按使用特性分类
第一类是存储设备，也称外存、辅存，是用以存储信息的主要设备。该类设备存取速
度较内存慢，但容量却大得多，价格也便宜。第二类就是IO设备，它又可分为输入设备、
输出设备和交互式设备。输入设备用来接收外部信息，如键盘、鼠标、扫描仪、视频摄像
交互式设备则是指集成的上述两类设备，主要是显示器，用于同步显示用户命令以及命令
执行的结果。
2）按传输速率分类
按传输速度的高低，可将I/O设备分为三类。第一类是低速设备，其传输速率仅为每
秒钟几个字节至数百个字节。典型的低速设备有键盘、鼠标器。第二类是中速设备，其传
输速率在每秒钟数千个字节至数十万个字节。典型的中速设备有行式打印机、激光打印机
等。第三类是高速设备，其传输速率在数十万字节至千兆字节。典型的高速设备有磁带机、
磁盘机、光盘机等。
2.设备与控制器之间的接口
IVO设备
通常，设备并不是直接与CPU进行通信，
至设备数据信号线
信号
而是与设备控制器通信，因此，在I/O设备中
缓冲转换器
控制器
数据
应含有与设备控制器间的接口，在该接口中有
状态信号线
控制逻辑
三种类型的信号（见图6-3所示），各对应一条
控制信号线
信号线。
（1）数据信号线。这类信号线用于在设备
图6-3设备与控制器间的接口
和设备控制器之间传送数据信号。对输入设备
而言，由外界输入的信号经转换器转换后，所形成的数据通常先送入缓冲器中，当数据量
达到一定的比特（字符）数后，再从缓冲器通过一组数据信号线传送给设备控制器，如图6-3
183